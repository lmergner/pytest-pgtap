name: pytest-pgtap
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.7, 3.8, 3.9]
        postgres-version: [11, 12, 13]
        pgtap-version: [v1.1.0, v1.0.0, v0.99.0, v0.98.0, master]

    services:
      postgres:
        image: "postgres:${{ postgres-version }}"

        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pytest-pgtap
          POSTGRES_USER: pytest-pgtap

        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v2
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Python requirements
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Assumes that the test requirements will be installed by setup.py
          python setup.py install
      - name: Get the pgTap repo
        uses: actions/checkout@v2
        with:
          repository: theory/pgtap.git
          path: pgtap
          ref: ${{ pgtap-version }}
      - name: Install pgTap
        run: |
          cd /pgtap
          make
          make installcheck
          make install
      - name: create extension pgTap
        run: |
          psql --no-psqlrc --dbname postgresql://pytest-pgtap:postgres@localhost/pytest-pgtap -c "create extension 'pgtap';"

    lint:
      needs: build
      steps:
        - name: Lint with flake8
          run: |
            pip install flake8
            flake 8 .
        - name: Lint with isort
          run: |
            pip install isort
            isort pytest_pgtap tests
        - name: Lint with black
          run: |
            pip install black
            black --check .

    test:
      needs: build
      steps:
        - name: Test with pytest
          run: |
            pytest
          env:
            POSTGRES_HOST: localhost
            POSTGRES_PORT: 5432
